## 1  现场总线控制技术与工业以太网

---

20世纪90年代以后随着现场总线控制技术的逐渐成熟，智能化与功能自治性的现场设备的广泛应用，嵌入式控制器、智能现场测控仪表和传感器等方便地接入了现场总线。

现场总线控制系统(FCS)是顺应智能现场仪表而发展起来的。它的初衷是用数字通讯代替4--20mA模拟传输技术，但随着现场总线技术与智能仪表管控一体化(仪表调校、控制组态、诊断、报警、记录)的发展，在控制领域内引起了一场前所未有的革命。

控制专家们纷纷预言：FCS将成为21世纪控制系统的主流。然而在控制界对FCS进行概念炒作的时候，却注意到它的发展在某些方面的不协调，其主要表现在迄今为止现场总线的通讯标准尚未统一：8种现场总线经过14年的纷争，最后IEC的现场总线标准化组织经投票，通过以下这8种现场总线成为IEC61158现场总线标准，即：FF H1，Control Net，ProfiBus，InterBus，P．Net，World FIP，Swift Net，FF之高速EtherNet即HSE。这8种现场总线互不兼容，这也使得各厂商的仪表设备难以在不同的FCS中兼容。

此外，FCS的传输速率也不尽人意，以基金会现场总线(FF)正在制定的国际标准为例，它采用了ISO的参考模型中的3层(物理层、数据链路层和应用层)和极具特色的用户层，其低速总线H1的传输速度为31．25kbps，高速总线H2的传输速度为1 Mbps或2．5Mbps，这在有些场合下仍无法满足实时控制的要求。又如广泛用于汽车行业的Can总线系统，其最高的传输速率为1 Mbps／40米；这些现场总线受通讯距离制约较大。

由于上述原因，使FCS在工业控制中的推广应用受到了一定的限制。

以太网具有传输速度高、低耗、易于安装和兼容性好等方面的优势，由于它支持几乎所有流行的网络协议，所以在商业系统中被广泛采用。但是传统以太网采用总线式拓朴结构和多路存取载波侦听碰撞检测(CSMA／CD)通讯方式，在实时性要求较高的场合下，重要数据的传输过程会产生传输延滞，这被称为以太网的“不确定性”。研究表明：商业以太网在工业应用中的传输延滞在2～30ms之间，这是影响以太网长期无法进入过程控制领域的重要原因之一。因此对以太网的研究具有工程实用价值，从而产生了一种新型的针对工业控制领域的以太网一工业以太网。

由于以太网具有应用广泛、价格低廉、通信速率高、软硬件产品丰富、应用支持技术成熟等优点，目前它已经在工业企业综合自动化系统中的信息层与控制层得到了广泛应用，并呈现向下延伸直接应用于工业控制现场的趋势。从目前国际、国内工业以太网技术的发展来看，目前工业以太网在控制层已得到广泛应用，并成为事实上的标准。未来工业以太网将在工业企业综合自动化系统中的现场设备之间的互连和信息集成中发挥越来越重要的作用。

工业以太网技术作为后起之秀，迅速抢占着其它总线形式的市场，推动其发展的两大动力是：光纤环网的应用、分布智能装置仪表。

光纤环网解决了两大问题：第一，轻松解决了在化工、矿业等极端条件的本质防爆问题，这一下子将以太交换设备向前推动了一个层次，使以太网可以到达工业现场层，第一次成为真正的FieldBus；第二，通过环网的冗余提高以太交换的可靠性，从而使工业以太网第一次可以应用对可靠性要求较高的应用环境中。而分布智能的装置仪表，解决了所谓以太传输时滞不确定性的诟病。首先，光纤环网的千兆交换速度，已经使绝大部分工业控制数据在可接受的时间内交换，对于大部分的工业生产信息，在100ms的时滞都是可以接受的。而如果所有的控制均需要通过集中的方式进行，显然这个时滞又太大了。可喜的是，工业控制装置和智能仪表正在向分布式发展。这种发展趋势，导致大量的本地控制指令不需要通过冗长的总线来传输，而是由仪表或装置的本地计算完成，这就不需要通过数据交换的方式苛刻地要求工业以太网的确定时延。

## 2  工业以太网实时性问题

---

工业以太网有着许多令人所信服的优点。但是传统商业以太网技术应用到工业现场仍然有着或多或少的不足和缺陷，经过许多研究机构和工程技术人员的不懈努力和对关键技术的研究，使传统以太网技术不断改进来满足工业现场控制要求。这些关键技术包括通信确定性和实时性技术、系统稳定性技术、系统互操作性技术、网络安全性技术、总线供电及本质安全与安全防爆技术等。下面就确定性和实时性做一些介绍。

### 2.1 通讯确定性和实时性技术

传统以太网采用总线式的拓扑结构和多路存取载波侦听／碰撞(CSMA／C通讯方式，即网络上的每个节点都通过竞争的方式来获取发送信息报文的权利，节点通过监听信道，当发现信道空闲时则把待发的信息报文发送出去，如果信道忙则处于等待状态。在发送信息后检测是否发生了碰撞，如果出现则退出信道等待重发。不难想象当网络负荷比较重的时候大量节点都在尝试重发进而导致网络堵塞，使一些节点的信息长时间得不到发送，这种特性称为以太网的不确定性。研究表明：传统以太网在工业控制中的传输延迟，对数据传送要求很高的场合是不能够应用的，这也影响了以太网技术在工业底层控制网络中的应用。

随着以太网技术的不断发展，工业以太网在确定性和实时性方面已经基本达到了工业现场实时控制的要求。

首先，在网络拓扑结构上采用了星形连接代替总线型连接。图1示意了两种不同的网络拓扑结构。其中的星形连接用网桥或路由器等设备将网络分割成多个网段(Segment)，在每个网段上以一个多口集线器为中心，将若干个设备或节点连接起来，这样挂接在同一网段上的所有设备形成一个冲突域(Collision)。每个冲突域均采用CSMA／CD机制来管理网络冲突。这种分段方法可以使每个冲突域的网络负荷减轻、碰撞几率减小。

![img](http://172.16.76.244:2000/static/images/ethernet_1.png)

图1  以太网网络拓扑结构的比较

## 3  Ethernet／IP协议简介

---

现场总线国际标准IEC 61158经过十几年的争论和斗争后，放弃了其制定单一现场总线标准的初衷，最终发布了包括8种(第3版修订后增加了两种类型，而成为10种类型)类型总线的国际标准。这说明各大总线各具特点、不可互相替代的局面得到世界工控界的认可。

目前有Modbus-IDA工业以太网，Ethernet／lP工业以太网，FF HSE工业以太网，ProfitNet工业以太网,Controlnet工业以太网,P．Net工业以太网，Swift Net工业以太网，World FIP工业以太网等几种协议。下来我们就各协议进行介绍。

### 3.1 Ethernet／IP工业以太网

EtherNet／IP(EtherNet Industry Protoco1)是适合工业环境应用的协议体系。它是由两大工业组织ODVA(OpenDeviceNet Vendors Association)ControlNet International所推出的最新的成员。和DeviceNet以及ControlNet一样，它们都是基于CIP(Control and Informal／on Protoco1)协议的网络。它是一种是面向对象的协议，能够保证网络上隐式的实时I／0信息和显式信息(包括用于组态参数设置、诊断等)的有效传输。

EtherNet／IP采用和DevieNet以及ControlNet相同的应用层协CIP(Control and Information Protoco1)，因此，它们使用相同的对象库和一致的行业规范，具有较好的一致性。EtherNet／IP采用标准的EtherNet和TCP／IP技术来传送CIP通信包，这样，通用且开放的应用层协议CIP加上已经被广泛使用的EtherNet和TCP／IP协议，就构成EtherNet／IP协议的体系结构。协议的各层结构如图2所示。

 

![img](http://172.16.76.244:2000/static/images/ethernet_2.png)

图2 应用CIP的EtherNet/IP

#### 3.1.1 Ethernet／IP协议模型及协议内容

1.物理层和数据链路层

EtherNet／IP在物理层和数据链路层采用以太网。其主要由以太网控制器芯片来实现。从图2可看出，不久的将来会出现更合适的物理层和数据链路层协议，

会出现相应的芯片。但是上面的协议无须改变。

2.网络层和传输层

EtherNet／IP在网络层和传输层采用标准的TCP／IP技术。对于面向控制的实时I／0数据，采用UDP／IP协议来传送，而对于显式信息(如组态、参数设置和诊断等)则采用TCP／IP来传送过程监控层流通的数据基本是显式信息，采用TCP／IP来传送，其优先级较低。而将来采用工业以太网EtherNet／IP协议的现场设备层，流通的数据基本是实时I／O数据，采用UDP／IP胁议来传送，其优先级较高。

3.控制及信息协议(ClP)

控制及信息协议(CIP)是一种为工业应用开发的应用层协议，被DeviceNet、ControlNet、EtherNet／IP等3种网络所采用，因此这3种网络相应地统称为CIP网络.

（1）CIP的特点有以下几点

①报文

CIP协议最重要的特点是可以传输多种类型的数据。工业应用中所需要传输的数据类型有I／O、互锁、配置、故障诊断、程序上载或下载等。这些不同类型的数据对传输服务质量的要求是不同的。重要的传输服务质量评价指标有确定性、单位时间内有通信行为的节点所占的比例、响应时间等。

CIP根据所传输的数据对传输服务质量要求的不同，把报文分为两种：显式报文和隐式报文。显式报文用于传输对时间没有苛求的数据，比如程序的上载下载、系统维护、故障诊断、设备配置等。由于这种报文包含解读该报文所需要的信息，所以称为显式报文。隐式报文用于传输对时间有苛求的数据，如I／O、实时互锁等。由于这种报文不包含解读该报文所需要的信息，其含义是在网络配置时就确定的，所以称为隐式报文。由于隐式报文通常用于传输I／O数据，隐式报文又称为I／O报文或隐式I／O报文。

在网络底层协议的支持下，CIP用不同的方式传输不同类型的报文，以满足它们对传输服务质量的不同要求。DeviceNet给予不同类型的报文不同的优先级，隐式报文使用优先级高的报头，显式报文使用优先级低的报头。ControlNet在预定时问段发送隐式报文，在非预定时问段发送显式报文。而Ethemet／IP用TCP来发送显式报文，用UDP来发送隐式报文。

②面向连接

CIP还有一个重要特点是面向连接，即在通信开始之前必须建立起连接，获取惟一的连接标识符(connection ID)。如果连接涉及到双向的数据传输，就需要两个CID。CID的定义及格式是与具体网络有关的，比如，DeviceNet的CID定义是基于CAN标识符的。通过获取CD，连接报文就不必包含与连接有关的所有信息，只需要包含CID即可，从而提高了通信效率。不过，建立连接需要用到未连接报文。未连接报文需要包括完整的目的地节点地址、内部数据描述符等信息，如果需要应答，还要给出完整的源节点地址。对应于两种CIP报文传输，CIP连接也有两种，即显式连接和隐式连接。建立连接需要用到末连接报文管理器(unconnected Message Manager—UCMM)，它是CIP设备中专门用于处理未连接报文的一个部件。如果节点A试图与节点B建立显式连接，它就以广播的方式发出一个要求建立显式连接的未连接请求报文，网络上所有的节点都接收到该请求，并判断是否发给自己的，节点B发现是发给自己的，其UCMM就做出反应，也以广播的方式发出一个包含CID的未连接响应报文，节点A接收到后，得知CID，显式连接就建立了。隐式连接的建立更为复杂，它是在网络配置时建立的，在这一过程中，需要用到多种显式报文传输服务。CIP把连接分为多个层次，从上往下依次是应用连接、传输连接和网络连接。一个传输连接是在一个或两个网络连接的基础上建立的，而一个应用连接是在一个或两个传输连接的基础上建立的。

③生产者／消费者模型

在传统的源／目的通信模式下，源端每次只能和一个目的地址通信，源端提供的实时数据必须保证每一个目的端的实时性要求，同时一些目的端可能不需要这些数据，因此浪费了时间，而且实时数据的传送时间会随着目的端数目的多少而改变。而在EtherNeL／IP所采用生产者／消费者通信模式下，数据之间的关联不是由具体的源、目的地址联系起来，而是以生产者和消费者的形式提供，允许网络上所有节点同时从一个数据源存取同一数据，因此使数据的传输达到了最优化，每个数据源只需要一次性的把数据传输到网络上，其它节点就可以选择性地接收这些数据，避免了浪费带宽，提高了系统的通信效率，能够很好地支持系统的控制、组态和数据采集。

（2） CIP 协议功能及特征

EtherNet/IP 其特色就是被称作控制和信息协议的CIP 部分。CIP 一方面提供实时I/O 通信，一方面实现信息的对等传输。其控制部分通过隐形报文来实现实时I/O 通信，信息部分则通过显性报文来实现非实时的信息交换。CIP 协议的一个重要的特性，是其介质无关性。即CIP 作为应用层协议的实施与底层介质无关。这就是人们可以在控制系统和I/O 设备上灵活实施这一开放协议的原因。同样，当未来新型的通讯手段出现时，人们一样可以方便地将其移植到更高性能的网络上实施，并且提供全部的网络功能，保证与原有现场总线或者以太网技术的透明性和一致性。

#### 3.1.2 EtherNet/IP 的通信机制

1. 通信模式

不同于源/目的通信模式，EtherNet/IP 采用生产/消费模式，它允许网络上的节点同时存取同一个源的数据。在生产/消费模式中，数据被分配一个唯一的标识，每一个数据源一次性的将数据发送到网络上，其他节点选择性的读取这些数据，从而提高了系统的通信效率。

1. CIP 报文通信

CIP 报文定义了显式报文和隐式报文两种报文类型, 隐式报文是对时间有苛刻要求的I/O信息(时间触发、控制器互锁等等)，此时数据量不大但需要高的速度或需要较长的源节点和其他节点连接时间，所以这部分采用的是速度较快的UDP 协议；显式报文数据量较大但不需要一直连接所以这部分采用TCP 协议。

CIP 报文的通信分为无连接的通信和基于连接的通信。无连接的报文通信是CIP 定义的最基本的通信方式。设备的无连接通信资源由无连接报文管理器UCMM 管理。无连接通信不需要任何设置或任何机制保持连接激活状态; 基于连接的报文通信是CIP 网路传递报文的另一种方式,可用来传递I/O数据和显式报文。这种通信方式支持生产者/消费者模式的多点传输关系, 一次向多个目的节点进行高效的数据传输。

### 3.2  ProfitNet工业以太网

#### 3.2.1 基本介绍

随着现场设备智能程度的不断提高，自动化控制系统的分散程度也越来越高。工业控制系统正由分散式自动化向分布式自动化演进，因此，基于组件的自动化（Component Based Automation，CBA）成为新兴的趋势。工厂中的相关的机械部件、电气/电子部件和应用软件等具有独立工作能力的工艺模块抽象成为一个封装好的组件，各组件间使用PROFINET连接。通过SIMATIC iMap软件，即可用图形化组态的方式实现各组件间的通讯配置，不需要另外编程，大大简化了系统的配置及调试过程。

通过模块化这一成功理念，可以显著降低机器和工厂建设中的组态与上线调试时间。在使用分布式智能系统或可编程现场设备、驱动系统和I/O时，还可以扩展使用模块化理念，从机械应用扩展到自动化解决方案。另外，也可以将一条生产线的单个机器作为生产线或过程中的一个"标准模块"进行定义。作为设备与工厂设计者，工艺模块化能够更容易、更好地对您的设备与系统进行标准化和再利用。使您能够对不同的客户要求更快、更具灵活性地作出反应。您可以对各台设备和厂区提前进行预先测试--极大地缩短系统上线调试阶段。作为系统操作者，从现场设备到管理层，你都可以从IT标准的通用通讯中获得好处。对现有系统进行扩展也很容易。

#### 3.2.2 实时通信

1)折叠TCP/IP标准通讯

PROFINET基于工业以太网技术，使用TCP/IP和IT标准。TCP/IP 是IT 领域关于通信协议方面事实上的标准，尽管其响应时间大概在100 ms的量级，不过，对于工厂控制级的应用来说，这个响应时间就足够了。

2)折叠实时（RT）通讯

对于传感器和执行器设备之间的数据交换，系统对响应时间的要求更为严格，大概需要5－10ms的响应时间。目前，可以使用现场总线技术达到这个响应时间，如PROFIBUS DP。

对于基于TCP/IP的工业以太网技术来说，使用标准通信栈来处理过程数据包，需要很可观的时间，因此，PROFINET提供了一个优化的、基于以太网第二层（Layer 2）的实时通讯通道，通过该实时通道，极大地减少了数据在通讯栈中的处理时间，因此，PROFINET获得了等同、甚至超过传统现场总线系统的实时性能。

3)折叠同步实时（IRT）通讯

在现场级通讯中，对通讯实时性要求最高的是运动控制（Motion Control），PROFINET的同步实时（Isochronous Real-Time, IRT）技术可以满足运动控制的高速通讯需求，在100个节点下，其响应时间要小于1ms，抖动误差要小于1μs，以此来保证及时的、确定的响应。

#### 3.2.3 PROFINET

1)折叠分布式现场设备

通过集成PROFINET接口，分布式现场设备可以直接连接到PROFINET上。

对于现有的现场总线通讯系统，可以通过代理服务器实现与PROFINET的透明连接。例如，通过IE/PB Link（PROFINET和PROFIBUS之间的代理服务器）可以将一个PROFIBUS网络透明的集成到PROFINET当中，PROFIBUS各种丰富的设备诊断功能同样也适用于PROFINET。对于其他类型的现场总线，可以通过同样的方式，使用一个代理服务器将现场总线网络接入到PROFINET当中。

2)折叠运动控制

通过PROFINET的同步实时（IRT）功能，可以轻松实现对伺服运动控制系统的控制。

在PROFINET同步实时通讯中，每个通讯周期被分成两个不同的部分，一个是循环的、确定的部分，称之为实时通道；另外一个是标准通道，标准的TCP/IP数据通过这个通道传输。

在实时通道中，为实时数据预留了固定循环间隔的时间窗，而实时数据总是按固定的次序插入，因此，实时数据就在固定的间隔被传送，循环周期中剩余的时间用来传递标准的TCP/IP数据。两种不同类型的数据就可以同时在PROFINET上传递，而且不会互相干扰。通过独立的实时数据通道，保证对伺服运动系统的可靠控制。

3)折叠网络安装

PROFINET支持除星形、总线形和环形拓扑结构。为了减少布线费用，并保证高度的可用性和灵活性，PROFINET提供了大量的工具帮助用户方便的实现PROFINET的安装。特别设计的工业电缆和耐用连接器满足EMC和温度要求，并且在PROFINET框架内形成标准化，保证了不同制造商设备之间的兼容性。

#### 3.2.4 安全

1)折叠标准与网络安全

PROFINET的一个重要特征就是可以同时传递实时数据和标准的TCP/IP数据。在其传递TCP/IP数据的公共通道中，各种业已验证的IT技术都可以使用（如http、HTML、SNMP、DHCP和XML等）。在使用PROFINET的时候，我们可以使用这些IT标准服务加强对整个网络的管理和维护，这意味着调试和维护中的成本的节省。

PROFINET实现了从现场级到管理层的纵向通讯集成，一方面，方便管理层获取现场级的数据，另一方面，原本在管理层存在的数据安全性问题也延伸到了现场级。为了保证现场级控制数据的安全，PROFINET提供了特有的安全机制，通过使用专用的安全模块，可以保护自动化控制系统，使自动化通讯网络的安全风险最小化。

2)折叠故障安全

在过程自动化领域中，故障安全是相当重要的一个概念。所谓故障安全，即指当系统发生故障或出现致命错误时，系统能够恢复到安全状态（即"零"态），在这里，安全有两个方面的含义，一方面是指操作人员的安全，另一方面指整个系统的安全，因为在过程自动化领域中，系统出现故障或致命错误时很可能会导致整个系统的爆炸或毁坏。故障安全机制就是用来保证系统在故障后可以自动恢复到安全状态，不会对操作人员和过程控制系统造成损害。

PROFINET集成了PROFISafe行规，实现了IEC61508中规定的SIL3等级的故障安全，很好的保证的整个系统的安全。

3)折叠过程自动化

PROFINET不仅可以用于工厂自动化场合，也同时面对过程自动化的应用。工业界针对工业以太网总线供电，及以太网应用在本质安全区域的问题的讨论正在形成标准或解决方案。PROFIBUS国际组织计划在2006年的时候会提出PROFINET进入过程自动化现场级应用方案。

通过代理服务器技术，PROFINET可以无缝的集成现场总线PROFIBUS和其它总线标准。今天，PROFIBUS是世界范围内唯一可覆盖从工厂自动化场合到过程自动化应用的现场总线标准。集成PROFIBUS现场总线解决方案的PROFINET是过程自动化领域应用的完美体验。

作为国际标准IEC61158的重要组成部分，PROFINET是完全开放的协议，PROFIBUS国际组织的成员公司在2004年的汉诺威展览会上推出了大量的带有PROFINET接口的设备，为PROFINET技术的推广和普及起到了积极的作用。随着时间的流逝，作为面向未来的新一代工业通讯网络标准，PROFINET必将为您和您的自动化控制系统带来更大的收益和便利。

### 3.3  Modbus-IDA工业以太网

Modbus是由Modicon(现为施耐德电气公司的一个品牌)在1979年发明的，是全球第一个真正用于工业现场的总线协议。

ModBus网络是一个工业通信系统，由带智能终端的可编程序控制器和计算机通过公用线路或局部专用线路连接而成。其系统结构既包括硬件、亦包括软件。它可应用于各种数据采集和过程监控。

ModBus网络只有一个主机，所有通信都由他发出。网络可支持247个之多的远程从属控制器，但实际所支持的从机数要由所用通信设备决定。采用这个系统，各PC可以和中心主机交换信息而不影响各PC执行本身的控制任务。

#### 3.3.1 基本信息

为更好地普及和推动Modbus在基于以太网上的分布式应用，目前施耐德公司已将Modbus协议的所有权移交给IDA(Interface for Distributed Automation，分布式自动化接口)组织，并成立了Modbus-IDA组织，为Modbus今后的发展奠定了基础。在中国，Modbus已经成为国家标准GB/T19582-2008。据不完全统计:截止到2007年，Modbus的节点安装数量已经超过了1000万个。

Modbus协议是应用于电子控制器上的一种通用语言。通过此协议，控制器相互之间、控制器经由网络(例如以太网)和其它设备之间可以通信。它已经成为一通用工业标准。有了它，不同厂商生产的控制设备可以连成工业网络，进行集中监控。此协议定义了一个控制器能认识使用的消息结构，而不管它们是经过何种网络进行通信的。它描述了一控制器请求访问其它设备的过程，如何回应来自其它设备的请求，以及怎样侦测错误并记录。它制定了消息域格局和内容的公共格式。

当在一Modbus网络上通信时，此协议决定了每个控制器须要知道它们的设备地址，识别按地址发来的消息，决定要产生何种行动。如果需要回应，控制器将生成反馈信息并用Modbus协议发出。在其它网络上，包含了Modbus协议的消息转换为在此网络上使用的帧或包结构。这种转换也扩展了根据具体的网络解决节地址、路由路径及错误检测的方法。

此协议支持传统的RS-232、RS-422、RS-485和以太网设备。许多工业设备，包括PLC，DCS，智能仪表等都在使用Modbus协议作为他们之间的通讯标准。

#### 3.3.2 特点

Modbus具有以下几个特点:

(1)标准、开放，用户可以免费、放心地使用Modbus协议，不需要交纳许可证费，也不会侵犯知识产权。目前，支持Modbus的厂家超过400家，支持Modbus的产品超过600种。

(2)Modbus可以支持多种电气接口，如RS-232、RS-485等，还可以在各种介质上传送，如双绞线、光纤、无线等。

(3)Modbus的帧格式简单、紧凑，通俗易懂。用户使用容易，厂商开发简单。

1）折叠Modbus网络传输

标准的Modbus口是使用RS-232-C兼容串行接口，它定义了连接口的针脚、电缆、信号位、传输波特率、奇偶校验。控制器能直接或经由Modem组网。

控制器通信使用主-从技术，即仅一设备(主设备)能初始化传输(查询)。其它设备(从设备)根据主设备查询提供的数据作出相应反应。典型的主设备:主机和可编程仪表。典型的从设备:可编程控制器。

主设备可单独和从设备通信，也能以广播方式和所有从设备通信。如果单独通信，从设备返回一消息作为回应，如果是以广播方式查询的，则不作任何回应。Modbus协议建立了主设备查询的格式:设备(或广播)地址、功能代码、所有要发送的数据、一错误检测域。

从设备回应消息也由Modbus协议构成，包括确认要行动的域、任何要返回的数据、和一错误检测域。如果在消息接收过程中发生一错误，或从设备不能执行其命令，从设备将建立一错误消息并把它作为回应发送出去。

 

2）折叠其它类型传输

在其它网络上，控制器使用对等技术通信，故任何控制器都能初始化和其它控制器的通信。这样在单独的通信过程中，控制器既可作为主设备也可作为从设备。提供的多个内部通道可允许同时发生的传输进程。

在消息位，Modbus协议仍提供了主-从原则，尽管网络通信方法是"对等"。如果一控制器发送一消息，它只是作为主设备，并期望从从设备得到回应。同样，当控制器接收到一消息，它将建立一从设备回应格式并返回给发送的控制器。

3）折叠查询回应周期

(1)查询

查询消息中的功能代码告之被选中的从设备要执行何种功能。数据段包含了从设备要执行功能的任何附加信息。例如功能代码03是要求从设备读保持寄存器并返回它们的内容。数据段必须包含要告之从设备的信息:从何寄存器开始读及要读的寄存器数量。错误检测域为从设备提供了一种验证消息内容是否正确的方法。

(2)回应

如果从设备产生一正常的回应，在回应消息中的功能代码是在查询消息中的功能代码的回应。数据段包括了从设备收集的数据:像寄存器值或状态。如果有错误发生，功能代码将被修改以用于指出回应消息是错误的，同时数据段包含了描述此错误信息的代码。错误检测域允许主设备确认消息内容是否可用。

#### 3.3.3 传输方式

在ModBus系统中有2种传输模式可选择。这2种传输模式与从机PC通信的能力是同等的。选择时应视所用ModBus主机而定，每个ModBus系统只能使用一种模式，不允许2种模式混用。一种模式是ASCII(美国信息交换码)，另一种模式是RTU(远程终端设备)。

用户选择想要的模式，包括串口通信参数(波特率、校验方式等)，在配置每个控制器的时候，在一个Modbus网络上的所有设备都必须选择相同的传输模式和串口参数。所选的ASCII或RTU方式仅适用于标准的Modbus网络，它定义了在这些网络上连续传输的消息段的每一位，以及决定怎样将信息打包成消息域和如何解码。在其它网络上(像MAP和Modbus Plus)Modbus消息被转成与串行传输无关的帧。

1）折叠传输模式特性

ASCII可打印字符便于故障检测，而且对于用高级语言(如Fortran)编程的主计算机及主PC很适宜。RTU则适用于机器语言编程的计算机和PC主机。

用RTU模式传输的数据是8位二进制字符。如欲转换为ASCII模式，则每个RTU字符首先应分为高位和低位两部分，这两部分各含4位，然后转换成十六进制等量值。用以构成报文的ASCII字符都是十六进制字符。ASCII模式使用的字符虽是RTU模式的两倍，但ASCII数据的译码和处理更为容易一些，此外，用RTU模式时报文字符必须以连续数据流的形式传送，用ASCII模式，字符之间可产生长达1s的间隔，以适应速度较慢的机器。

控制器能设置为两种传输模式(ASCII或RTU)中的任何一种在标准的Modbus网络通信。

2)ASCII模式

当控制器设为在Modbus网络上以ASCII(美国标准信息交换代码)模式通信，在消息中的每个8Bit字节都作为一个ASCII码(两个十六进制字符)发送。这种方式的主要优点是字符发送的时间间隔可达到1秒而不产生错误。

代码系统

- 十六进制，ASCII字符0...9,A...F
- 消息中的每个ASCII字符都是一个十六进制字符组成每个字节的位
- 1个起始位
- 7个数据位，最小的有效位先发送
- 1个奇偶校验位，无校验则无

1个停止位(有校验时)，2个Bit(无校验时)错误检测域

- LRC(纵向冗长检测)

3)折叠RTU模式

当控制器设为在Modbus网络上以RTU(远程终端单元)模式通信，在消息中的每个8Bit字节包含两个4Bit的 十六进制字符。这种方式的主要优点是:在同样的波特率下，可比ASCII方式传送更多的数据。

 

代码系统

8位二进制，十六进制数0...9，A...F

消息中的每个8位域都是一或两个十六进制字符组成每个字节的位

1个起始位8个数据位，最小的有效位先发送1个奇偶校验位，无校验则无

1个停止位(有校验时)，2个Bit(无校验时)

#### 3.3.4 CRC

1)折叠CRC

CRC域是两个字节，包含一16位的二进制值。它由传输设备计算后加入到消息中。接收设备重新计算收到消息的CRC，并与接收到的CRC域中的值比较，如果两值不同，则有误。

CRC是先调入一值是全"1"的16位寄存器，然后调用一过程将消息中连续的8位字节各当前寄存器中的值进行处理。仅每个字符中的8Bit数据对CRC有效，起始位和停止位以及奇偶校验位均无效。

CRC产生过程中，每个8位字符都单独和寄存器内容相异或(XOR)，结果向最低有效位方向移动，最高有效位以0填充。LSB被提取出来检测，如果LSB为1，寄存器单独和预置的值或一下，如果LSB为0，则不进行。整个过程要重复8次。在最后一位(第8位)完成后，下一个8位字节又单独和寄存器的当前值相或。最终寄存器中的值，是消息中所有的字节都执行之后的CRC值。

CRC添加到消息中时，低字节先加入，然后高字节。

CRC-16错误校验程序如下:报文(此处只涉及数据位，不指起始位、停止位和任选的奇偶校验位)被看作是一个连续的二进制，其最高有效位(MSB)首选发送。报文先与X↑16相乘(左移16位)，然后看X↑16+X↑15+X↑2+1除，X↑16+X↑15+X↑2+1可以表示为二进制数11000，0000，0000，0101。整数商位忽略不记，16位余数加入该报文(MSB先发送)，成为2个CRC校验字节。余数中的1全部初始化，以免所有的零成为一条报文被接收。经上述处理而含有CRC字节的报文，若无错误，到接收设备后再被同一多项式(X↑16+X↑15+X↑2+1)除，会得到一个零余数(接收设备核验这个CRC字节，并将其与被传送的CRC比较)。全部运算以2为模(无进位)。

 

习惯于成串发送数据的设备会首选送出字符的最右位(LSB-最低有效位)。而在生成CRC情况下，发送首位应是被除数的最高有效位MSB。由于在运算中不用进位，为便于操作起见，计算CRC时设MSB在最右位。生成多项式的位序也必须反过来，以保持一致。多项式的MSB略去不记，因其只对商有影响而不影响余数。

生成CRC-16校验字节的步骤如下:

①装如一个16位寄存器，所有数位均为1。

②该16位寄存器的高位字节与开始8位字节进行"异或"运算。运算结果放入这个16位寄存器。

③把这个16寄存器向右移一位。

④若向右(标记位)移出的数位是1，则生成多项式10，1000，000，0000，001和这个寄存器进行"异或"运算;若向右移出的数位是0，则返回③。

⑤重复③和④，直至移出8位。

⑥另外8位与该十六位寄存器进行"异或"运算。

⑦重复③~⑥，直至该报文所有字节均与16位寄存器进行"异或"运算，并移位8次。

⑧这个16位寄存器的内容即2字节CRC错误校验，被加到报文的最高有效位。

另外，在某些非ModBus通信协议中也经常使用CRC16作为校验手段，而且产生了一些CRC16的变种，他们是使用CRC16多项式X↑16+X↑15+X↑2+1，单首次装入的16位寄存器为0000;使用CRC16的反序X↑16+X↑14+X↑1+1，首次装入寄存器值为0000或FFFFH。

2)折叠LRC

LRC错误校验用于ASCII模式。这个错误校验是一个8位二进制数，可作为2个ASCII十六进制字节传送。把十六进制字符转换成二进制，加上无循环进位的二进制字符和二进制补码结果生成LRC错误校验(参见图)。这个LRC在接收设备进行核验，并与被传送的LRC进行比较，冒号(:)、回车符号(CR)、换行字符(LF)和置入的其他任何非ASCII十六进制字符在运算时忽略不计。

 

### 3.4  Controlnet工业以太网

ControlNet是近年来推出的面向控制层的实时性现场总线网络，在同一物理层介质链路上提供时间关键性I/O数据和报文数据，包括程序的上载/下载，组态数据和端到端的报文传递等通讯支持，是具有高度确定性、可重复的高速控制和数据采集网络，I/O性能和端到端通讯性能都较传统网络有较大的提高。

#### 3.4.1 原理

ControlNet是基于生产者/消费者模式

(Producer/ConsumerModel)的网络。ControlNet允许在同一链路上有多个控制器共存，支持输入数据或端到端的多路发送，这就大大的减少了网络上的交通量，提高了网络效率和网络性能。ControlNet是高度确定性、可重复性的网络。ControlNet能预见数据何时能够可靠传输到目标的能力，同时数据的传输时间不受网络节点添加/删除情况或网络繁忙状况而保持恒定的能力。在实际应用中，通过网络组态时选择性设定有计划I/O分组或互锁时间，这些要求能得到更进一步的保证。

生产者/消费者模式允许网络中所有的节点同时获取来自同一数据源的数据。最终，该模式提高了效率，因为数据只发送一次，而与数据使用者(Consumer)的数量无关，并且具有精确的同步性。因为数据将同时到达每一个节点。生产者-消费者模式的优点在于:多个节点可以同时消费(Consume，即读取)来自同一个生产省(Producer，即数据源)所提供的数据。节点间易于同步，可以获得更为精确的系统性能，设备可以实现自主通信，无需系统主站。ControlNet提供了简单、高度确定而且灵活的传输数据方式。ControlNet在执行操作、数据实时监控时不会影响到I/O控制的性能。因此，ControlNet非常适用于一些控制关系有复杂关联、要求控制控制信息同步、协调实时控制、数据传输速度要求较高的应用场合。

ControlNet的明显优点是:同一链路上满足I/O数据、实时互锁、端到端报文传输和编程/组态等信息应用的多样要求;是确定性、可重复性的控制网络，适合离散控制和过程控制;同一链路上允许有多个控制器同时共存;输入数据和端到端信息的多路发送支持;可选的介质冗余和本征安全;安装和维护的简单性;网络上节点居于对等地位，可以从任意节点实现网络存取;灵活的拓扑结构(总线型、树型、星型等)和介质选择(同轴电缆、光纤和其它)。

#### 3.4.2 ControlNet网络

控制网是由控制网国际有限公司(ControlNet International,Ltd.)首先提出来的一种开放式网络。罗克韦尔自动化公司的设计之初就提出了三层网络的概念,分别是以太网，Controlnet网，Deveicenet网，上层信息用于全厂的数据采集和程序维护;中层自动化和控制层实现实时I/O的控制,控制器的互锁和报文的传送;底层设备网用于底层设备的低成本,高效率的信息集成.其中控制网通讯采用当今流行的生产者/消费者模式,该模式采用多信道广播式,定点传送，属于预定性信息，每个信号对应一个单独的地址，占一个网络节点，网络所有节点同步,信息吞吐量大,速度快,网络效率高;因此控制网具有高速,高度确定和可重复性的网络,特别适用于对时间苛刻要求的复杂应用场合的信息传输，但是Controlnet网络中的节点数目是有限制的，最高不能超过99个，节点数超过限制会发生不可预测的故障，未超过但是过多会影响网速，造成网络迟滞。Controlnet用同轴网线或者光纤作为介质，相对而言，Controlnet比西门子的Profibus网络更加稳定，易于维护，有助于实现无缝连接。

#### 3.4.3 控制网国际有限公司

控制网国际有限公司(ControlNet International,Ltd.)是1997年7月由Rockwell等22家企业发起成立ControlNet国际化组织(CI)，是个非赢利独立组织，主要负责向全世界推广ControlNet技术(包括测试软件)。目前已有50多个公司参加，如ABB Roboties 、Honeywell Inc.、日本横河、东芝、Omron等大公司。

#### 3.4.4 可建造ControlNet的设备

**1.ControlLogix，ProcessLogix，FlexLogix系列**

1756系列ControlLogix55xx控制器，集成多种控制功能:顺序控制、传动控制和过程控制。网络的桥接无需控制器。高速控制平台上的高速数据传输。1757系列ProcessLogix控制器，5兆数据速率的高吞吐量工业网络。使用扩展的诊断方法，维护简单，多点传输(Multicast)特性允许多个控制器共享输入数据，可选的网络冗余，增加可靠性。1794系列FlexLogix54xx控制器，面向分布式控制的中小型系统，无与伦比的灵活性，与ControlLogix等同样采用RSLoqix5000编程，多种编程语言支持，就地安装可以扩充多达16个FlexI/0模块，可以安装任何两个可选的ControlNet(可选同轴或者光纤介质)、DeviceNet或者lOOMbpsEtherNet/IP。扩展现场I/O和智能设备，通过ControlNet或者EtherNet/IP，实现对等通讯、数据采集、程序下载或者实时互锁。

 

**2.PLC与SLC控制器系列**

PLC-5可编程控制器内置ControINet通讯,,通过ControINet口，提供高速通讯能力,允许处理器输入中断和可选的定时中断。SLC扫描器口适配器模块，性能最佳的网络扩展远程I/0解决方案-增强的系统性能适宜于SLC逻辑监视的故障设备的出错诊断列表。PLC-5热备系统，提供高性能的、确定性的数据传递，控制程序在主控制器和后备控制器中同步执行.包括两种模式的热备操作:同步和异步SLC报文发送模块，程序上传/下载，支持RSView等用户人-机界面软件实现数据采集。

**3.基于PC的控制器系列**

SoftLogix5800系列，RSLogix5000软件编程，PCI格式的通讯卡(DeviceNet扫描器，ControlNet扫描器，EtherNet/IP通讯卡，运动控制卡等)，ISA/EISA总线扫描器卡，IOLinx系列软件。PCI扫描器卡，能够维护重要的网络规划和组态参数，备份网络上的其他数据，标准的即插即用型本地PCI总线卡，兼容当前所有的吏面计算机和工业终端，ISA/EISA总线扫描器卡双BNC接头，支持介质冗余，通过LED组态指示灯的显示可以观察网络和控制卡的诊断信息SoftLogix5800软件，多个编程选项简化维护和升级工作，多种灵活可选的I/O和网络，多个MMI(人-机界面)选项。

**4. I/0框架型和模块型**

FLEXI/0系列，每个适配器可连接多达128点离散I/0或64个模拟通道。可以对故障或是移走的I/0模块进行诊断.独立的部件，可以任意混合使用不同I/0类型，减少了外部接线端子成本，短路保护，本质安全模块。1771PLC-5机架I/0，多个控制器和终端能够共享模块输入数据，品种齐全包括各种特殊应用模块。1746SLC-500I/0，可以与PLC5热备系统配合使用，具有节点地址和模块，组态显示，SLC机架供电。ControlLogix1756I/0，无需硬件设置开关完全的软件逐点组态，可软件逐点组态的浮点数和工程定标，模块自行计算，无需编程，不占用处理器资源，完全带电拔插，减少停机日寸间，适用于ControlLoqix和ProcessLoqix控制器。1734PointI/0，2至4点的I/0密度您精打细算，ControlNet适配器支持冗余介质和网络接入口(NAP)，通过Control、DeviceNet、Profibus/DP等适配器灵活扩展，小尺寸，大身手:带电拔插，逐点指示和诊断，多种I/O类型和接线端子，电子模块和接线段子底座可分离设计。

### 3.5  World FIP工业以太网

#### 3.5.1 概述

WorldFip现场总线组织成立于1987年。目前已有一百多个成员，其中许多是工控领域的世界著名大公司，如Honeywell、西技来克（Cegelec）、阿尔斯通（Alstom）、施耐德（Schneider）等。前期产品是Fip（Factory Instrumentation Protocol）。Fip是法国标准，后来采纳了IEC国际标准（61158-2）改名为WorldFip。相应的欧州标准是EN50170-3。不久前国内也成立了“WorldFip技术推广中心”。我国引进的一些大型工程，如上海地铁、岭奥核电站、军粮城电厂等都可以看到这种现场总线。目前正在建造的世界上能量最高的大型强子对撞机已选定WorldFip为工程标准总线之一。该加速器周长27公里，耗资数十亿美元，将于2004年建成。

由于篇幅的限制，这里只介绍其有特色之处。网络管理、远程服务、远程下载、出错处理、广播方式、重新同步、应答方式等等与其它网络协议差不多的部分不在这里介绍。

#### 3.5.2 WorldFip的特点

WorldFip总线是面向工业控制的，其主要特点可归纳为实时性、同步性、可靠性。

WorldFip 目前使用的传输速率是31.5K，1M和2.5M。典型速率为1M bit/s。典型的传输介质是工业级屏蔽双绞线。对接线盒、9针D型插头座等都有严格的规定。每个网段最长为1公里。加中继器（Repeater）以后可扩展到5公里。

WorldFip与Internet类似，使用曼彻斯特码传输。但它是一种令牌网。网络由仲裁器和若干用户站组成。

WorldFip 使用信息生产者和消费者的概念，和通常意义上的输出量、输入量略有区别。每个生产者或消费者变量有一个IP地址。每个用户站可以有例如16个生产者/消费者变量。任何时候，生产者只能有一个，而消费者可以是1个或多个。

WorldFip的设计思想是，按一定的时序，为每个信息生产者分配一个固定的时段，通过总线仲裁器诸个呼叫每个生产者，如果该生产者已经上网，应在规定时间内应答。生产者提供必要的信息，同时提供一个状态字，说明这一信息是最新生产的，还是过去传送过的老信息。消费者接收到信息时，可根据状态字判断信息的价值。

WorldFip 将信息分为：周期性同步数据、周期性异步数据和非周期性消息包。同步数据严格地按确定的时序呼叫，接下去是周期性异步数据，用于对同步性要求不太高的数据传送。最后呼叫消息包。周期性同步数据、异步数据用于时序要求严格，数据包不大的信息（8~128字节），消息包指时序要求不严格，数据量大的信息，例如每包256字节。形象地比喻，网线可以看成一个流水的管道。一半（或1/3、2/3,由用户设计）流的是水，是不可压缩的。即周期性同步和异步数据。另一半可以看成是空的，留给非周期性消息包的传送。

网络仲裁器是整个网络通信的主宰者。网络仲裁器轮番呼叫每一个生产者变量。整个网线上总是有信号的。如果若干时间间隔内（例如几十毫秒）没有监听到网上的信号、则可以诊断为网络故障，此时可以自动将冗余热备份网线切换上去，也可以设计成各用户站回本质安全态。WorldFip 在网络安全性方面的考虑有其独到之处。在一个网络中可以有一个或多个网络仲裁器。在任意给定时刻，只有一个在起作用，其他处于热备份态，监听网络状态。而每个用户站的网络冗余则是通过一个控制器驱动两路驱动器，接入两个独立的网线实现的。当一个网线被破坏，自动切换到另一网线。

#### 3.5.3 WorldFip 协议

除用户层外，WorldFip使用以下三层通信协议：应用层、数据链路层、物理层。

用户层指有用的信息，一个变量（生产者或消费者），可以是8字节，也可以是16、32、48......乃至128字节。一则消息，则可以长至256字节。以下三层是在WorldFip网络控制器中自动实现的，不需要用户CPU干预。它相应于7层网络通信协议的1、2和7层。

应用层在用户层信息的前面加上两个字节的识别码（ID）。这两个字节第一个是变量类型即所谓PDU类型。第二个字节是数据长度。

数据链路层则在应用层基础上加上一头一尾。头上是一个字节的状态字，表示该信息是最近刷新的，还是重复以前的数据。尾上加两个字节，用于CRC校验。

到物理层，则在数据链路层基础上再加上头尾。头上加两个字节，一个是前同步字符，由10101010组成，第二个是帧开始分界符，由1、高电平、低电平、1、零、高电平、低电平、零组成。尾部加一个帧结束字节，由1、高电平、低电平、高电平、低电平、1、零、1、组成。

综上所述，三层协议一共在有用信息两端增加了8个字节。当速率为1M时，帧与帧之间的间隔可设定在10～70μS之间。如果每个数据都是8字节，有用通量在200K～300 Kbit/s之间。如果数据长度为128字节，有用通量可达800K bit/s。

在1M速率下，如果扫描周期为10mS。假设5mS用于周期性同步和异步数据，5mS用于传送信息包，则5mS中可以扫描23个8字节变量或4个128字节变量。如果网上真的有250个用户站，每站有16个变量，即总共4000个变量，一半的时间留给消息包传输，则一次扫描约需要2秒。

#### 3.5.4 WorldFip总线典型器件

1．用于总线仲裁器的典型IC是VLSI公司的FullFip2。这是一个84引脚的芯片，使用时需要外扩独享存储器（Private memory）。有最多2M寻址空间，可主管最多4000个用户站，6万个以上变量。考虑到上述扫描周期不宜太长，用户站不可能这么多。

该芯片可方便地与Intel CPU或Motorola 单片机接口。可设计成PC机内的一块总线仲裁卡，也可以方便地与Motorola 16/32位单片机接口，例如MC68HC3XX、MC68HC16等。

FullFip2与WorldFip的连接是通过总线驱动器经变压器耦合实现的。

FullFip2主要用于总线仲裁，也可用于用户站。FullFip2内部有近100个寄存器，编程时较为复杂。一些公司提供C语言的函数库用于总线仲裁器的编程与开发。

2．MicroFip是一种低价位、用于用户站的IC，也是VLSI产品。对于I/O端口≤16的用户站，MicroFip可独立工作（Stand alone 方式）。用户事先定义的，网络故障时各输出端口应该输出的值、初值等参数可远程下载。这是一个100引脚的表面贴芯片。

作为单片机接口芯片，它可以方便地与8051、68HC11/12/16等单片机接口，此时该用户站可处理16个变量（生产者或消费者）。由于片内有512字节的变量缓冲区，每个数据变量的大小可为n×8字节（0≤n≤7）。而最长的消息包可以大到256字节。

3．总线驱动与变压器。WorldFip用的总线驱动器与其它总线驱动器的不同之处在于，除了实现曼彻斯特编码、解码功能之外，它还提供总线监听与看门狗功能，这为总线的热备份、总线冗余提供了方便，提高了总线的安全性。总线驱动芯片是一个28引脚的表面贴芯片。

变压器用于驱动器与传输介质的隔离，驱动器与变压器之间应加上保护与抗干扰措施。

符合WorldFip协议的芯片还有一些，如FIPIU2、FIPCOI等。不在此详述。

#### 3.5.5 开发工具

除一些公司提供用于FullFip2和MicroFip编程的C语言程序库以外，最值得一提的是WorldFip协议分析器。其硬件是插在PC机内的一块卡。用于采集WorldFip网线上的信号。软件名为Fip Watcher。在Windows下运行。开发者给定触发条件以后，Fip Watcher在屏幕上显示数据包的内容和每个数据包之间的时间关系。这个工具硬件相当简单，而使用起来比示波器、逻辑分析仪都方便、直观，价格也便宜许多。

另外，一些公司还提供开发散件，包括主要控制器芯片，驱动器芯片，变压器等。也有PC机上的演示板，用于总线仲裁器。或者一块PC 机上的卡，使某一PC机成为一个用户站。还有以MicroFip芯片加驱动、变压器耦合等三部分组成的评估板可供使用。该板可单独使用，也可以方便地与Intel 8051或各种Motorola 单片机接口。

#### 3.5.6 目前存在的一些问题和应用前景

由于WorldFip的发展经历了一个十余年的发展过程，而最终被国际上认可成为国际标准还是最近几年的事。各公司都声称支持WorldFip现场总线协议，而不少公司使用的是他们自己设计的专用芯片。使用的类似标准有Fip、FipIO等等。如果全部使用某公司的产品，一般不会有什么问题。这些公司还提供上层的编程工具等。如果同时使用两家不同公司的产品，或将根据WorldFip协议自行开发的设备连入从某公司购得的网络，则会出现数据格式不一致，不能接入的问题。

在大型强子对撞机工程中，欧洲核子研究中心希望购买施耐德公司的PLC，用于总线仲裁，而用户站则将根据需要自行开发，结果出现了上述问题。目前此类问题正在解决之中。

由于WorldFip现场总线依照工业控制系统的要求，不但严格定义了通信协议，也严格定义了符合工业标准的传输介质、接线盒、插头座等。在实时性、同步性、冗余性方面独具特色。速度更高的、以光纤为介质的高速网也不断推出。预计将来的几年中，在工控领域，WorldFip总线将会得到越来越广泛的应用。

## 4  Ethernet／IP 通信适配器硬件设计与实现

---

EtherNet／IP硬件设备开发主要有2种方式：一种是基于单板计算机系统；另外一种是开发嵌入式系统。嵌入式系统应用广泛，有非常多资源可供设计者使用，同时嵌入式系统硬件制作成本低，硬件设备可以设计的更为紧凑，有利于系统的小型化。下来介绍采用嵌入式系统设计Ethernet／IP通信适配器。

### 4.1 硬件系统总体架构

Ethernet／IP通信适配器作为工业控制中的网络设备，对数据处理能力、数据收发的实时性、可靠性上较商用以太网有着更严格的规范和要求，硬件必须能够满足这些功能及要求。而微处理器是系统的控制核心，其性能的好坏直接决定了系统性能的优劣；因此，本通信适配器选用三星公司的ARM9 S3C2410为CPU，其有丰富的外围接口功能，强大的处理能力。本系统硬件设计以S3C2410为核心，外围扩展了64MbitsSRAM、64Mbits NAND FLASH、以太网控制其CS8900、RS232串口、I/O接口、JTAG程序实时仿真接口等。系统总体硬件如图3

![img](http://172.16.76.244:2000/static/images/ethernet_3.png)

图3 系统总体硬件

### 4.2 电源设计

本通信适配器可以接现场I／O模块(现场I／O模块分为数字I／O及模拟I／O)，因此，设计电源时需充分考虑电源的驱动能力。电源不仅要给通信适配器供电，而且，需要给I／O模块的数字电路部分供电。本设计采用高效的开关电源设计，可满足8个扩展I／O模块的驱动能力。通信适配器中，不同的芯片采用的所要求的供电电压是不一样的。S3C2410需要的供电电压有：3．3V的数字电压及模拟电压、1．8V的数字电压及模拟电压、1．8V的PLL源电压；SRAM、NAND FLASH、I／O采用3．3V电压；JTAG、以太网控制其采用5V电压供电。工业以太网现场提供24VDC电源，因此，设计的电源模块必须提供把24VDC转换成5V、3．3V及1．8V的能力。

### 4.3 复位电路设计

由于ARM芯片的高速、低电压供电和低功耗导致其噪声容限较低，对电源的纹波、瞬时响应性能、时钟源的稳定性和电源监控的可靠性等诸多方面提出了更高的要求。为了保证系统在上电启动及电压不稳定时能够正确工作，系统设计中采用了专门的微处理器电源监控芯片MAX708TESA。电路如图4所示。

![img](http://172.16.76.244:2000/static/images/ethernet_4.png)

图4  电源监控及复位电路

在图4中，信号RESET连接到以太网控制器CS8900的复位引脚，因为CS8900的复位信号为高有效；信号RESET连接到S3C2410的复位引脚／RESET以及芯片内部JTAG接口电路的复位脚TRST。当复位按键Sl按下时，MAX708T立即输出复位信号，其引脚RESET输出高电平复位信号，引脚RESET输出低电平复位信号；此时S3C2410及以太网控制器CS8900都将复位。

ARM微处理器必须保证在稳定的复位状态下启动，当微处理器在未知状态时，必须使它保持复位状态。MAX708TESA保证低电压的时候处理器处于复位状态，避免系统在上电、掉电及电源状态不稳定的时候代码执行出错。当上电的时候，如果电源达到1V，／RESET引脚输出逻辑低电平，RESET引脚输出逻辑高电平。当电源超出了复位的门栏电压，MAX708TESA的内部定时器保证／RESET和RESET引脚保持200ms的复位信号，这就保证了系统在电源不稳定或者电源过低的情况下始终维持在复位状态，降低系统运行出错的可能性。

### 4.4 以太网通讯接口设计

#### 4.4.1 以太网电路原理

以太网控制器是Ethernet／IP通信适配器中一个非常重要的物理部件，它实现以太网的数据链路层协议。为了保证设备能够很好地满足工业应用的要求，所选用的以太网控制器需具备以下一些特点：能在工业环境中运行，对高温低温、噪声、震动等有一定的抵抗能力；支持全双工通讯；支持10Mbit／s或100Mbit／s传输速率等。S3C2410A没有内置的以太网控制器，本文采用Cirrus Logic公司开发的CS8900A—IQ3作为Ethernet／IP通信适配器的以太网控制CS8900A-IQ3主要特点是：lOMbit／s的传输速率、支持全双工运作模式、内建缓冲区提供传送接收讯框(Frames)、可对错误的封包自动排除等；此外，其特有的PacketPagel”结构可以自动调适网络交通的模式以及系统可用的资源。以太网通讯接口设计中还需使用隔离变压器，其主要作用是把设备的有源部分和其网络接口隔离开，以避免干挠网络的运行。隔离变压器应该提供尽可能高的共模抑制比，ODVA／CI推荐采用在30HZ时共模抑制比在59dB以上的隔离变压器。

#### 4.4.2 以太网芯片CS8900A-IQ3功能描述

![img](http://172.16.76.244:2000/static/images/ethernet_5.png)

图5  CS8900A-CQ3功能图

在电源开启或硬件复位后，CS8900A--IQ3要传送或接收封包时必须先芯片内部的组态、控制寄存器作参数的设置，比如说：存储器的基底位址、以太网络的物理位址、什么形态的讯框可以被接收和底层媒体介面是什么等等设置。这些参数的来源有两个地方：一个是由host透过ISA汇流排写入CS8900A-CQ3，另一个则是通过外部EEPROM自动载入进来。在所有寄存器设置完毕后CS8900A-CQ3便可进行相关动作**.**基本上CS8900A—CQ3的主要运作有两个部份：封包传送、封包接收。

封包传送：

在CS8900A-CQ3的封包传送过程中有两个阶段：

(1)封包传送第一个阶段：

主机将封包数据搬移至CS8900A—C03的缓冲存储器，这样子的搬移动作是在主机发出传送命令时所发生的。传送命令是要通知CS8900A-CQ3有封包数据需要被传送，并且何时要被传送(可在CS8900A-CQ3缓存器内设置成5，381，1021或是所有bytes被传送出去)，以及如何被传送出去(有无CRC、添加的位数据等等)。在传送命令发出后，传送的长度也要告知，这样CS8900A-CQ3需要多少的缓冲空间才可被配置出来。当足够的缓冲空间被配置出来后，主机便可透过I／O模式或是Memory的模式，将封包数据写入CS8900A-CQ3的内部存储器。

(2)封包传送第二个阶段：

CS8900A—CQ3将封包数据转换成以太网络讯框，之后送到网络CS8900A—CQ3会在传送缓冲空间累积到足够的数据(先前在CS8900A—CQ3缓存器内设置成5，381，1021或是所有bytes被传送出去等情形)，便马上传送出去。被传送出去的数据依照IEEE802．3以太网络讯框的格式(如下图所示)传送到网络上，以太网络讯框的最大数据酬载量(Payload)为1500 Bytes，最小为46 Bytes，如果上层封包数据量(包含CRC即Cyclic Redundancy Check，也就是FCS即Frame CheckSequence)小于46Bytes，那么CS8900A-CQ3会依照缓存器的设定来决定是否要填加位以补足讯框的最小量，最后再加上4 Bytes FCS送出。

封包接收：

(1)封包接收的第一个阶段：

CS8900A-CQ3接收以太网络讯框后，将讯框存放在内部芯片的内存中，将前导的字节(preamble)以及Start of Frame启始字节移除掉，然后利用地址过滤器比对是否该接收的讯框目的地的地址与网络芯片所设置的地址相同，如果正确的话，便存放在CS8900A—CQ3内部存储器，然后CS8900A-CQ3检查CRC以及相关设定，

以更进一步确认讯框之无误，然后通知微处理器讯框已被接收的事件。

(2)封包接收的第二个阶段：

主机利用ISA总线来传送已接收的讯框至主机上的内存存放。而这个传送的动作可以利用I／0模式、Memory模式或DMA模式达成。

### 4.5 串行通讯接口设计

S3C2410A内置3通道UART控制器，可以基于DMA模式或中断模式工作，支持5bits、6bits、7bits或者8bits串行数据发送／接收。本文采用MAXIMG公司为嵌

入式低功耗应用设计的MAX3232作为串口通讯收发器，MAX3232工作电压为3．3V，输出电平完全兼容RS232工业标准，最大收发速率为120kbps。本文设计Ethernet／IP通讯模块可通过串口直接与PC机连接，并使用串口为程序调试打印信息。串行通讯接口如图6所示：

![img](http://172.16.76.244:2000/static/images/ethernet_6.png)

图6 RS232接口电路图

### 4.6 主从USB接口设计

包括一个USB主机端口和一个USB设备端口。主机端口连接外围设备，如鼠标等，设备端口用于连接PC机。S3C2410A芯片内集成了USB主从控制器，因此，电路上只需加效应管驱动即可构成完整的USB电路，无需加任何USB芯片，这大大简化了电路设计。

![img](http://172.16.76.244:2000/static/images/ethernet_7.png)

图7 USB接口

### 4.7 外部I／0扩展接口设计

Ethernet／IP通信适配器采用总线模式与多个数字I／O模块相连接，在通信适配器内部给每个I／O模块分配了一个的物理地址，S3C2410A通过具体的物理地址直接读写I／O模块的数据。在S3C2410A与I／O接口之间采用了总线驱动器件，一方面提高主控制器的总线驱动能；另一方面可以隔离S3C2410A系统总线与外部I／O模块直接连接。外部扩展I／O接口原理如图4．12所示。图8中／CER为外部I／O模块的片选信号，／RW输出型I／O的写信号，／OE为输入型I／O的读信号， T为I／O模块产生的中断信号。对于比较重要的I／O可以采用中断的方式进行读写，正常情况下，以查询方式读写I／O数据。

 

![img](http://172.16.76.244:2000/static/images/ethernet_8.png)

图8  外部扩展IO接口原理

## 5  EtherNet/IP 工业以太网优缺点及发展前景

---

EtherNet/IP 工业以太网具有许多优点,比如由其组成的系统兼容性和互操作性好,资源共享能力强,可以很容易的实现将控制现场的数据与信息系统上的资源共享; 数据的传输距离长、传输速率高;易与Internet 连接,低成本、易组网,与计算机、服务器的接口十分方便,受到了广泛的技术支持。基于商业以太网开发的各种以太网报文侦听和流量优化控制软件，甚至可以不加改变的应用到工业以太网控制系统中。

但是，工业以太网也有瓶颈，主要是缺乏实时性和确定性、报文利用率低、回路供电、实时性环境适应等问题。以太网采用的CSMA/CD 协议，不支持优先级。报文头部比较大，载荷数据相对较少，相对现在广泛应用的一些现场总线协议而言，报文利用率较低。总线上无电源。这不但增加了重新购买电源和布置电源线的费用，而且现有以太网线比现场总线更容易受到电磁干扰。缺乏工业级的接插件。由于工业现场存在的腐蚀性气体，震动、维修和检测时的经常拔插等问题。因此需要一种通用工业级接插件。但是工业级接插件的引入势必增加设备的投资。所以，目前EtherNet/IP 工业以太网的应用主要是在自动化领域的信息层和控制层。在设备层则使用ODVA 支持的ControlNet DeviceNet现场总线，利用总线在设备层的抗干扰能力强等优点作为以太网的补充。

随着网络交换技术、全双工通信、流量控制等技术的发展，EtherNET/IP 工业以太网有一网到底的美景，它可以一直延伸到企业现场设备控制层，所以被人们普遍认为是未来控制网络的最佳解决方案。
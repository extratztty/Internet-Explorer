##  1. **简介**

DNP(Distributed Network Protocol，分布式网络规约)是一种应用于自动化组件之间的通讯协议，常见于电力、水处理等行业。SCADA可以使用DNP协议与主站、RTU、及IED进行通讯。在电力系统中的应用最为广泛。

DNP协议标准由IEEE提出，参考了IEC 870-5、以及其他一些IEC协议。

---

[ SCADA系统（Supervisory Control And Data Acquistion）

数据采集与监视控制系统

以计算机为基础的生产过程控制与调度自动化系统，可以对现场的运行设备进行监视和控制]

---

以下是DNP协议的一些**特点**：

- DNP3.0规约是一种分布式网络协议，适用于要求高度安全、中等速率和中等吞吐量的数据通信领域。
- DNP3.0规约以IEC870-5标准为基础
- DNP3.0规约采用网络通信方式。
- DNP3.0规约支持点对点、一点多址、多点多址和对等的通信方式。
- DNP3.0规约支持问答式和自动上报数据传输方式。
- DNP3.0规约支持通信冲突碰撞避免/检测方式，能保证数据传输的可靠性。
- DNP3.0规约支持传送带时标的量，尤其有利于配电自动化系统采集分时电度值和分析事故原因。
- 灵活采取适当的扫描方式，DNP3.0规约可以在一定程度上实现实时优先级。

### 2. **协议格式**

在OSI七层模型上简化为四层：应用层、伪传输层、数据链路层、物理层。数据链路层负责通信链路的建立、数据的接收、发送和初步处理；伪传输层负责应用数据的分包和组包；应用层实现真正的信息处理。

![dnp3_1.png](http://172.16.76.244:2000/static/images/dnp3_1.png)

![dnp3_2.png](http://172.16.76.244:2000/static/images/dnp3_2.png)

DNP3.0规约多采用问询—应答方式，但也允许从站主动上送信息。

一个典型的DNP应答处理过程一般为：

**主站：**

1. 应用层组织好信息后交给伪传输层；
2. 传输层把应用层报文分帧，每帧前加上一个报头TH，然后交给链路层；
3. 链路层则把每帧报文分块，每块最多16字节，每个块后加一个16位的CRC校验码，同时链路层有一个固定长度的报头，包含有地址、长度等信息；主站链路层发送报文，并且在规定时间内没有收到对方确认时进行重发（如果要求）；

**从站：**

1. 链路层接收完一帧报文后，进行CRC、地址、长度等合法性检查，如对方链路层要求确认，则回答ACK或NACK报文，然后把接收正确的报文去掉报头和每块的CRC后交给传输层；
2. 传输层检查TH报头，并在多帧报文时按顺序把报文组成一个完整的应用层数据包，然后交给应用层；
3. 应用层收到报文后，如对方应用层要求确认，先回答一个Confirm 报文，然后对信息进行处理，再组织回答报文（回答过程类似主站）。

###  2.1 数据链路层

**2.1.1  FT3帧长格式：**

一个FT3帧被定义为一个固定长度的**报头**，随后是可选的**数据块**，每个数据块附有一个16位的CRC校验码。固定的报头含有2个字节的起始字，一个字节的长度（LENGH），一个字节的链路层控制字（CONTROL），一个16位的目的地址，一个16位的源地址和一个16位的CRC校验码。

![dnp3_5.png](http://172.16.76.244:2000/static/images/charts/dnp3_5.png)


- 起始字：2字节，0x05，0x64；


- 长  度：1字节，是控制字、目的地址、源地址和用户数据之和（不含CRC）。5≤长度≤255；
- 目的地址：2个字节，低字节在前；0xFFFF为广播地址；
- 源地址：2个字节，低字节在前；
- 用户数据：跟在报头之后的数据块，每16个字节一块，最后一个块包含剩下的字节，可以是1到16个字节。每个数据块都有一CRC循环冗余码挂在后面。
- CRC循环冗余码：2个字节。在一个帧内，挂在每个数据块之后。

CRC生成多项式：G(x)=x16+x13+x12+x11+x10+x8+x6+x5+x2+1 (0x3d65)；CRC按字节反向排列；

**2.1.2 控制字与功能码：**

链路层通信控制字包含有本帧的传输方向，帧的类型以及数据流控制信息。

主站和子站都既可以作为源方站和副方站

![dnp3_6.png](http://172.16.76.244:2000/static/images/charts/dnp3_6.png)


- DIR：方向位(direction)，表示此帧是由主站发出(1)还是从站发向主站(0)。
- PRM：源发标志位(primary)，表示此帧是来自源发方还是来自响应方。DNP允许从站主动上送报文，因此源发方既可以是主站，也可以是从站。
- FCB：（源发站报文PRM=1）帧的计数位，0、1交替变化，设计此位的目的是进行简单的纠错。
- FCV：（源发站报文PRM=1）帧的计数位的有效标志，为1时，FCB位有效。
- DFC：（响应站报文PRM=0）数据链路层数据缓冲区溢出；当主站收到此位后，应该停止发送，改为询问对方的链路层状态，直到对方回答链路层可用后再发送报文；
- RES：（响应站报文PRM=0）保留（0）；


- 功能码：

结合PRM位进行分析

![dnp3_7.png](http://172.16.76.244:2000/static/images/charts/dnp3_7.png)


1. RESET命令(0)：

Primary（主）：在上电或通信失败后，不断向SECONDARY下发（FCV=0, FCB=x, PRM=1, DIR=x）并等待，直到有ACK回答；

Secondary（从）：在上电或通信失败后，一直等待RESET命令；然后回答ACK响应（DFC=x, PRM=0, DIR=x）,将FCB设为1（即接收到的下一帧应该其FCB=1）。

2. Reset of user process(1)：

用于复位链路使用者（指传输层）进程，主要是复位链路状态；回答ACK/NACK；

3. Test(2)：

从站收到后，将FCB与预期的FCB比较，如相符，回答ACK（FCB翻转），否则，重复送上次发送的最后一帧；

4. User Data(3)：

从站收到后，如果链路使用者（指传输层）可以接收数据，回答ACK，否则回答NACK；

5. Unconfirmed User Data（4）：

从站收到后交给链路使用者（指传输层），不做回答；

6. Request Link Status（9）：

从站收到后，回答链路状态，如果链路使用者（指传输层）可以接收数据，DFC=0,否则DFC=1。

注：FCV/FCB: 主站在上电或通信失败后，不断向从站下发RESET命令，FCV=0, FCB=x（即不进行FCB校验）；从站回答ACK，完成握手，并保存主站FCB状态（设为FCB’=1）；接着主站下发其他命令，如果主站需要进行FCB校验，其下发命令中FCB=1，FCV=1；从站收到命令后，如FCV=1，则将主站命令中的FCB与保存的FCB’比较，如相等，FCB校验OK，把FCB’翻转为0，否则丢弃本帧报文。

当FCV=0时，不进行FCB校验。

### 2.2 传输层

DNP的传输层是一个伪传输层。伪传输层用于在源站和从站之间传送超出链路规约数据单元（LPDU）定义长度的信息。其格式如下：

![dnp3_8.png](http://172.16.76.244:2000/static/images/charts/dnp3_8.png)


其中：

传输层报头TH：传输控制字，1个字节

数据块：应用层用户数据1-249个字节

由于数据链路层的FT3帧格式中长度字的最大限制为255，因此传输层数据块的最大长度为：255-5（链路层控制字+源地址+目的地址）-1（TH）=249。当应用层用户数据长度大于249字节时，传输层将以多帧报文方式传送，并每帧前加TH控制字。

如1234=249+249+249+249+238，分5帧传送。

传输层报头（TH）格式：

![dnp3_9.png](http://172.16.76.244:2000/static/images/charts/dnp3_9.png)


- FIN：此位置“1”，表示本用户数据是整个用户信息的最后一帧
- FIR：此位置“1”，表示本用户数据是整个用户信息的第一帧
- 序号：表示这一数据帧是用户信息的第几帧，帧号范围为0~63，每个开始帧可以是0~63中的任何一个数字，下一帧自然增加，63以后接0。

当用户数据只有一帧时，FIR和FIN都为1。

传输层收到一帧报文后，如果FIR等于1，则记下帧序号，等待下一帧，直到收到有FIN标志的帧为止。如果接收帧系列的序号都正确，则把所有帧组成一个完整的包，否则认为报文出错。

### 2.3 应用层

DNP的应用层负责真正的信息处理。其报文分为请求报文和响应报文两类。在DNP中，只有指定的主站能够发送应用层的请求报文，而从站则只能发送应用层的响应报文。

**2.3.1 应用报文格式：**

- 应用请求报文

![dnp3_10.png](http://172.16.76.244:2000/static/images/charts/dnp3_10.png)


- 应用响应报文：

![dnp3_11.png](http://172.16.76.244:2000/static/images/charts/dnp3_11.png)

其中：

- 请求（响应）报头：标识报文的目的，包含应用规约控制信息（ACPI）；
- 对象标题：标识随后的数据对象；
- 数    据：在对象标题内指定的数据对象；

**2.3.2 应用报文报头字段的定义：**

请求报头有两个字段。每个字段为8位的字节，说明如下：

![dnp3_12.png](http://172.16.76.244:2000/static/images/charts/dnp3_12.png)


响应报头有三个字段。前两个字段为8位的字节，第三个字段为两个字节，说明如下：

![dnp3_13.png](http://172.16.76.244:2000/static/images/charts/dnp3_13.png)


其中：

- 应用控制：一个字节的长度，格式如下：

![dnp3_15.png](http://172.16.76.244:2000/static/images/charts/dnp3_15.png)


- FIR：此位置“1”，表示本报文分段是整个应用报文的第一个分段；
- FIN：此位置“1”，表示本报文分段是整个应用报文的最后一个分段；
- CON：此位置“1”，表示接受到本报文时，对方须要给予确认；
- 序号：表示分段的序号，0-15（RESPONSE响应报文）或16-31（UNSOLICITED非请求报文）；

响应报文的序号应等于请求报文的序号（如是多分段请求报文，则响应序号等于末分段的序号），多分段响应报文的首段序号等于请求报文的序号，后续段顺序增加。

注：规约推荐每个分段的缓冲区长度为2048字节（约9个链路帧）。

当应用层数据超过本层的缓冲区长度时，就把数据分成几段。但每段都应该是一个完整的应用层报文。同一个对象标题的数据不应该跨段。

 “段、帧”的有关说明：

DNP规约中，报文以帧（FRAME）为单位发送，链路层每次最多收/发一帧，除去报头等控制信息外，最多只能有249字符用于应用数据。但应用数据一般都超过249个字节，因此，需要在传输层把一个完整的应用层回答数据分成几帧发送，每帧前加一个TH头。假设需要3帧，第一帧TH头中FIR位＝1，表示是第一帧，记录初始帧序号THSEQ＝帧序号SQ0（值可以是0－63中任意数），第二帧TH头中FIR＝FIN=0，帧序号THSEQ＝SQ0+1；第三帧TH头中FIR位＝0，FIN=1，表示是最后一帧，帧序号THSEQ＝SQ0+2。这样，就形成“一问多答”，如主站发“读全遥测数据”命令，从站连续回答3帧，主站根据FIR/FIN和THSEQ，把3帧报文拼成一个完整的应用数据段，再交给应用层处理。在分帧时，不考虑应用数据的具体含义。

“段”的使用与“帧”类似，但一般很少有多段数据。

- 功能码：标识报文的目的，一个字节的长度；

![dnp3_16.png](http://172.16.76.244:2000/static/images/charts/dnp3_16.png)
![dnp3_17.png](http://172.16.76.244:2000/static/images/charts/dnp3_17.png)
![dnp3_18.png](http://172.16.76.244:2000/static/images/charts/dnp3_18.png)
![dnp3_19.png](http://172.16.76.244:2000/static/images/charts/dnp3_19.png)
![dnp3_20.png](http://172.16.76.244:2000/static/images/charts/dnp3_20.png)
![dnp3_21.png](http://172.16.76.244:2000/static/images/charts/dnp3_21.png)

- **内部状态IIN：**

主站发出的应用层报文中无IIN标志位。

共两个字节，16位，每一位分别表示从站的当前的各种状态。

![dnp3_22.png](http://172.16.76.244:2000/static/images/charts/dnp3_22.png)
![dnp3_23.png](http://172.16.76.244:2000/static/images/charts/dnp3_23.png)

- **对象标题**（Object Header）：

报文的对象标题指定包含在报文中的数据对象或是被用来响应此报文的数据对象。格式如下：

![dnp3_24.png](http://172.16.76.244:2000/static/images/charts/dnp3_24.png)

- **对象**（Object）：

两个字节，指定对象组以及跟在标题后面的对象的变化。对象段的格式如下：

![dnp3_25.png](http://172.16.76.244:2000/static/images/charts/dnp3_25.png)

对象段规定一个对象组和在该组内的对象变体。对象的组别与变体结合起来可以唯一的规定报文所指定的对象。对象组指定数据的基本形式（如：模拟输入），对象变体指定数据的形式（如16位模拟输入或32位模拟输入）。当请求报文的变体＝0时，意味着请求所有该对象组的数据。

- **限定词（Qualifier）、变程（范围，Range）**

限定词为1个8位的字节段，规定变程段的意义。变程说明数据对象的数量、起点和终点的索引或所讨论的对象的标识符。

限定词段的格式如下：

![dnp3_26.png](http://172.16.76.244:2000/static/images/charts/dnp3_26.png)

其中：

R：保留位，置为零。

- **索引规模**（Index Size）：3个Bits，规定前置于每个数据对象的索引规模或对象的规模。

![dnp3_27.png](http://172.16.76.244:2000/static/images/charts/dnp3_27.png)
![dnp3_28.png](http://172.16.76.244:2000/static/images/charts/dnp3_28.png)

- **限定词码**（Qualifier Code）：4个Bits，用以规定变程（Range）意义。

![dnp3_29.png](http://172.16.76.244:2000/static/images/charts/dnp3_29.png)
![dnp3_30.png](http://172.16.76.244:2000/static/images/charts/dnp3_30.png)

- **变程段**(Range)

1. 当限定词码取值0~5时，变程段包含1个开始范围（Start Range）和1个结束范围（Stop Range）。
2. 当限定词码取值6时，表示所指定的是所要求的数据类型的全部数据对象，因此Range段的长为零（即无变程段）。
3. 当限定词码取值为7~9时，则变程段由一个计数值所组成，它指明所讨论的数据对象的数目。

实际报文分析：

例如：

**（1）**05 64 05 c0 01 00 03 00 3a 48 ：

这帧报文是复位报文，第一和第二个字节是固定的起始字节；

第三个字节（05）是报文的长度；

第四个字节是链路层控制字，c0表示是主站发往从站，而且此帧是原发帧，功能码=0，表示复位；

第五个和第六个字节01 00是目的地址，该地址排列是低字节在前高字节在后，换为十进制是 1；

第七和第八字节03 00 是源地址，排列方式与目的地址相同，换为十进制是 3；

最后两个字节是CRC 校验码。

**（2）**再如：

主站的请求报文为：05 64 0b c4 02 00 01 00 83 24 c0 c1 01 3c 03 06 1c 68

其中：

05 64 是固定的起始字节；

0b是报文长度，为11个字节，c4是链路层控制字，表示是主站发往从站，而且此帧是原发帧，功能码=4，表示有用户数据，但对方链路层无需回答ACK或NACK；

02 00是目的地址，即RTU地址；

01 00是调度地址；

83 24是CRC校验码，

c0 是传输层控制字，表示本报文既是第一帧又是最后一帧，帧序号是 0。

c1是应用层控制字，表示本报文既是第一段又是最后一段，段序号是1，本报文不需要应用层确认。

01是应用层功能码，意义为读取从站数据，

3c 03是Group 和Variation，在本例中解释为变化遥测数据，06是限定词，表示全部数据。

1c 68 是CRC校验码。

应答报文为：05 64 0f 44 01 00 02 00 fa 4a d2 c1 81 02 00 1e 02 28 00 00 0f dd

其中：

05 64 意义同上；

0f 表示长度；

44 表示是从站发往主站，是源发帧，后随数据是不需要对方链路层确认的用户数据；

01 00 表示目的地址；

02 00 表示源地址；

fa 4a为CRC校验码；

d2是传输层报头TH，表示本报文既是第一帧又是最后一帧，帧序号是18；

c1是应用层控制字，表示本报文既是第一段又是最后一段，段序号是1，本报文不需要确认；

81（十进制是129）表示是响应报文；

02 00是内部状态指示字，这里表明一类数据有变化；

1e 02 表示数据对象为16位遥测；

28是QC，表示有变程段，变程段是一个16位的数据项数目，而且在每个数据项中，有一个16位的索引；

00 00 是变程，表示变化遥测数目=0；

0f dd是CRC校验码。

## 3. 调试工具

**opendnp3**

opendnp3是automatak开源的基于IEEE-1815 (DNP3)的开源协议栈。

**Aegis™**

Aegis™是automatak开源的一个针对工控协议进行模糊测试(Fuzz)的框架，其中包含对DNP3协议模糊测试的模块，官方的Project Robus项目曾经发布过多个应用在DNP3协议健壮性上的漏洞，官方在发布MODBUS模块后貌似没有再继续开源了。

**Protocol Test Harness**

Protocol Test Harness是Triangle MicroWorks公司开发的一款协议仿真、调试软件，软件可以仿真多种工控协议包括DNP3，可以方便你完成调试、仿真。

## 4. DNP 3.0答疑整理

1. DNP3.0与DNP的关系？

DNP如今发展到DNP3.0

2. RTU是什么？

RTU(Remote Terminal Unit)过程终端单元，是SCADA系统的基本组成单元，负责对现场信号、工业设备的监测和控制。

3. IED是什么？

智能电子设备，全称：Intelligent Electronic Device，简称为IED。IEC61850标准对IED定义如下：“由一个或多个处理器组成，具有从外部源接收和传送数据或控制外部源的任何设备，即电子多功能仪表、微机保护、控制器，在特定的环境下在接口所限定范围内能够执行一个或多个逻辑接点任务的实体 ”

4. 关于TEC 870-5

国际电工学会( IEC)技术委员会第 57号远程控制系统数据传输标准

5. 几种通信方式

**点对点**：点对点通信实现网内任意两个用户之间的[信息交换](https://baike.baidu.com/item/%25E4%25BF%25A1%25E6%2581%25AF%25E4%25BA%25A4%25E6%258D%25A2/716328)。

分为

①单工通信：数据只能单向传输，有固定的发送者和接受者。  如：遥控器。

②半双工通信：数据可双向交替传输，但不能同时。       如：对讲机。

③全双工通信：数据可同时双向传输。 如：电话。

现在点对点通信方式大部分是全双工通信。

**一点多址**：一点多址微波通信系统又称“无线用户集中器”。中心微波站分别与不同方向的多个用户微波站进行通信的系统。根据距离的长短，中心站与用户站之间可不设中继站，也可设一个或多个中继站。一个中继站可对一个用户站，也可对多个用户站进行通信。 [1]

中心站、中继站和用户站所组成的网络结构可成辐射型、分支型和直线型等。系统工作方式有频分多址和时分多址两类。与同等容量的有线电路相比较，当通信距离大于5～6km时，采用该系统更为经济，常用作县以下农村电话网的组成部分或市郊电话网的延伸。

**多点多址**：多址通信（multiple access communication），多个用户使用一个公共信道实现各用户间通信的方式，又称任意选址通信和多元联接 。在多址通信的联接方式下，一个地点（地址）的[通信设备](https://baike.baidu.com/item/%25E9%2580%259A%25E4%25BF%25A1%25E8%25AE%25BE%25E5%25A4%2587)可以同时与另外多个地点（地址）的通信设备相联接；参与多址通信的各个地点的通信设备实际上构成了一个[通信网](https://baike.baidu.com/item/%25E9%2580%259A%25E4%25BF%25A1%25E7%25BD%2591)。在工程上，多址通信也称为点对多点通信。

多址通信广泛应用于移动通信网、卫星通信网，也广泛用于计算机区域网络上，是一种很有发展前途的通信方式。

多址通信的具体联接方式有很多，目前常用的多址联接方式有频分多址FDMA、时分多址TDMA和码分多址CDMA，以及它们的组合方式。

**对等**：对等通信peer-to-peer communication，为了使数据分组从源传送到目的地，源端OSI模型的每一层都必须与目的端的对等层进行通信，这种通信方式称为对等层通信。

6. 使用protocol test harness,仿真出DNP3.0的数据包

![dnp3_3.png](http://172.16.76.244:2000/static/images/dnp3_3.png)

![dnp3_4.png](http://172.16.76.244:2000/static/images/dnp3_4.png)

